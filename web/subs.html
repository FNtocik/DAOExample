<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Subscription</title>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
<input hidden type="text" id="languageId" value="">
<a href="logout">Logout</a>
<div>
    <input type="button" onclick="redirectToPublications()" value="Publications">
    <input type="button" onclick="redirectToReaders()" value="Readers">
    <input type="button" onclick="redirectToPayment()" value="Payments">
</div>
<div>
    <form>
        <label>
            <input hidden type="text" id="subscriptionId" value="1"><br>
        </label>
        <label>
            <select id="readerId">
            </select><br>
        </label>
        <label>
            <select id="publicationId">
            </select><br>
        </label>
        <label>
            <select id="paymentId">
            </select><br>
        </label>
        <label>
            <input type="date" id="startDate" value=""><br>
        </label>
        <label>
            <input type="date" id="endDate" value=""><br>
        </label>
        <input type="button" onclick="edit()" value="Save">
        <input type="button" onclick="add()" value="Add">
        <input type="button" onclick="del()" value="Delete">
    </form>
</div>
<div>
    <table>
        <thead>
            <tr>
                <td>id</td>
                <td>reader</td>
                <td>publication</td>
                <td>payment</td>
                <td>start date</td>
                <td>end date</td>
            </tr>
        </thead>
        <tbody id="allSubscriptions">

        </tbody>
    </table>
</div>
</body>
<script>
    var oldRow = null;
    var subscriptionElement = document.getElementById("subscriptionId");
    var languageElement = document.getElementById("languageId");
    var readerSelect = document.getElementById("readerId");
    var publicationSelect = document.getElementById("publicationId");
    var paymentSelect = document.getElementById("paymentId");
    var dateStartInput = document.getElementById("startDate");
    var dateEndInput = document.getElementById("endDate");
    var table = document.getElementById("allSubscriptions");
    table.addEventListener('click', function (event) {
        if(oldRow != null)
            oldRow.style.background = "white";
        var row = event.target.parentNode;
        row.style.background = "blue";
        subscriptionElement.value = row.childNodes[0].textContent;
        get();
        oldRow = row;
    });

    getAll();
    fillReaderSelect();
    fillPaymentSelect();
    fillPublicationSelect();

    function add() {
        var request = new XMLHttpRequest();
        var readerId = readerSelect.options[readerSelect.selectedIndex].value;
        var publicationId =
            publicationSelect.options[publicationSelect.selectedIndex].value;
        var paymentId =
            paymentSelect.options[paymentSelect.selectedIndex].value;
        var startDate = dateStartInput.value;
        var endDate = dateEndInput.value;
        var languageId = languageElement.value;
        var params = "readerId=" + readerId + "&publicationId=" + publicationId
            + "&paymentId=" + paymentId + "&languageId=" + languageId +
            "&endDate=" + endDate + "&startDate=" + startDate;
        request.open("PUT", "subscription?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        request.send();
    }

    function edit() {
        var request = new XMLHttpRequest();
        request.open("POST", "subscription", true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        var subscriptionId = subscriptionElement.value;
        var readerId = readerSelect.options[readerSelect.selectedIndex].value;
        var publicationId =
            publicationSelect.options[publicationSelect.selectedIndex].value;
        var paymentId =
            paymentSelect.options[paymentSelect.selectedIndex].value;
        var startDate = dateStartInput.value;
        var endDate = dateEndInput.value;
        var languageId = languageElement.value;
        var msg = "subscriptionId=" + subscriptionId + "&readerId=" +
            readerId + "&publicationId=" + publicationId + "&paymentId=" +
            paymentId + "&languageId=" + languageId + "&endDate=" + endDate +
            "&startDate=" + startDate;
        request.send(msg);
    }

    function del() {
        var request = new XMLHttpRequest();
        var params = "subscriptionId=" + subscriptionElement.value;
        request.open("DELETE", "subscription?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        request.send();
    }

    function get() {
        var request = new XMLHttpRequest();
        var params = "subscriptionId=" + subscriptionElement.value;
        request.open("GET", "subscription?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            var subscription = JSON.parse(this.responseText);
            subscriptionElement.value = subscription.subscriptionId;
            searchValueInSelect(readerSelect.options, subscription.readerId);
            searchValueInSelect(paymentSelect.options, subscription.paymentId);
            searchValueInSelect(publicationSelect.options, subscription.publicationId);
            dateStartInput.value = subscription.startDate;
            dateEndInput.value = subscription.endDate;

        };
        request.send();
    }

    function getAll() {
        var requestToSubs = new XMLHttpRequest();
        requestToSubs.open("GET", "subscription", true);
        requestToSubs.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        requestToSubs.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            while(table.firstChild){
                table.removeChild(table.firstChild);
            }
            var subscriptions = JSON.parse(this.responseText);
            languageElement.value = subscriptions[0]["languageId"];
            for(var i = 0; i < subscriptions.length; i++){
                var tr = document.createElement("tr");
                var tdId = document.createElement("td");
                var textId = document.createTextNode(subscriptions[i]["subscriptionId"]);
                var tdReaderId = document.createElement("td");
                var textReaderId = document.createTextNode(subscriptions[i]["readerId"]);
                var tdPaymentId = document.createElement("td");
                var textPaymentId = document.createTextNode(subscriptions[i]["paymentId"]);
                var tdPublicationId = document.createElement("td");
                var textPublicationId = document.createTextNode(subscriptions[i]["publicationId"]);
                var tdStartDate = document.createElement("td");
                var textStartDate = document.createTextNode(subscriptions[i]["startDate"]);
                var tdEndDate = document.createElement("td");
                var textEndDate = document.createTextNode(subscriptions[i]["endDate"]);
                tdId.appendChild(textId);
                tdReaderId.appendChild(textReaderId);
                tdPaymentId.appendChild(textPaymentId);
                tdPublicationId.appendChild(textPublicationId);
                tdStartDate.appendChild(textStartDate);
                tdEndDate.appendChild(textEndDate);
                tr.appendChild(tdId);
                tr.appendChild(tdReaderId);
                tr.appendChild(tdPublicationId);
                tr.appendChild(tdPaymentId);
                tr.appendChild(tdStartDate);
                tr.appendChild(tdEndDate);
                table.appendChild(tr);
            }
        };
        requestToSubs.send();
    }

    function fillReaderSelect() {
        var request = new XMLHttpRequest();
        request.open("GET", "reader", true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if (this.readyState != XMLHttpRequest.DONE)
                return;
            var readers = JSON.parse(this.responseText);
            for(var i = 0; i < readers.length; i++){
                readerSelect[readerSelect.length] = new
                Option(readers[i]["login"], readers[i]["readerId"]);
            }
        };
        request.send();
    }

    function fillPaymentSelect() {
        var request = new XMLHttpRequest();
        request.open("GET", "payment", true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if (this.readyState != XMLHttpRequest.DONE)
                return;
            var payments = JSON.parse(this.responseText);
            for(var i = 0; i < payments.length; i++){
                paymentSelect[paymentSelect.length] = new
                Option(payments[i]["cost"], payments[i]["paymentId"]);
            }
        };
        request.send();
    }

    function fillPublicationSelect() {
        var request = new XMLHttpRequest();
        request.open("GET", "publication", true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if (this.readyState != XMLHttpRequest.DONE)
                return;
            console.log(this.responseText);
            var publications = JSON.parse(this.responseText);
            for(var i = 0; i < publications.length; i++){
                publicationSelect[publicationSelect.length] = new
                Option(publications[i]["name"] + " " +
                    publications[i]["author"],
                    publications[i]["publicationId"]);
            }
        };
        request.send();
    }

    function searchValueInSelect(options, valueToSelect) {
        for(var i = 0; i < options.length; i++){
            if(+options[i].value === valueToSelect){
                options[i].selected = true;
                return;
            }
        }
    }

    function redirectToReaders() {
        var request = new XMLHttpRequest();
        request.open("GET", "reader.html", true);
        request.onreadystatechange = function (ev) {
            if(this.readyState == XMLHttpRequest.DONE)
                window.location.href = "reader.html";
        };
        request.send();
    }

    function redirectToPublications() {
        var request = new XMLHttpRequest();
        request.open("GET", "publication.html", true);
        request.onreadystatechange = function (ev) {
            if(this.readyState == XMLHttpRequest.DONE)
                window.location.href = "publication.html";
        };
        request.send();
    }

    function redirectToPayment() {
        var request = new XMLHttpRequest();
        request.open("GET", "payment.html", true);
        request.onreadystatechange = function (ev) {
            if(this.readyState == XMLHttpRequest.DONE)
                window.location.href = "payment.html";
        };
        request.send();
    }

    function logout() {
        var request = new XMLHttpRequest();
        request.open("POST", "logout", true);
        request.send();
    }
</script>
</html>