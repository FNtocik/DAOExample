<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Readers</title>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
<input hidden type="text" id="languageId" value="">
<div>
    <a href="publication.html">Publications</a>
    <a href="subscription.html">Subscriptions</a>
</div>
<div>
    <form>
        <label>
            <input hidden type="text" id="readerId" value="">
        </label>
        <label>
            <input type="text" id="login">
        </label><br>
        <label>
            <input type="text" id="password">
        </label><br>
        <input type="button" onclick="edit()" value="Save">
        <input type="button" onclick="add()" value="Add">
        <input type="button" onclick="del()" value="Delete">
    </form>
</div>
<div>
    <table>
        <thead>
        <tr>
            <td>ID</td>
            <td>login</td>
            <td>password</td>
        </tr>
        </thead>
        <tbody id="allReaders">

        </tbody>
    </table>
</div>
</body>
<script>
    var oldRow = null;
    var readerElement = document.getElementById("readerId");
    var languageElement = document.getElementById("languageId");
    var loginInput = document.getElementById("login");
    var passwordInput = document.getElementById("password");
    var table = document.getElementById("allReaders");
    table.addEventListener('click', function (event) {
        if(oldRow != null)
            oldRow.style.background = "white";
        var row = event.target.parentNode;
        row.style.background = "blue";
        readerElement.value = row.childNodes[0].textContent;
        get();
        oldRow = row;
    });

    getAll();

    function add() {
        var request = new XMLHttpRequest();
        var login = loginInput.value;
        var password = passwordInput.value;
        var languageId = languageElement.value;
        var params = "login=" + login + "&password="
            + password + "&languageId=" + languageId;
        request.open("PUT", "reader?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        request.send();
    }

    function edit() {
        var request = new XMLHttpRequest();
        request.open("POST", "reader", true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        var readerId = readerElement.value;
        var login = loginInput.value;
        var password = passwordInput.value;
        var languageId = languageElement.value;
        var msg = "readerId=" + readerId + "&login=" + login + "&password="
            + password + "&languageId=" + languageId;
        request.send(msg);
    }

    function del() {
        var request = new XMLHttpRequest();
        var params = "readerId=" + readerElement.value;
        request.open("DELETE", "reader?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            getAll();
        };
        request.send();
    }

    function get() {
        var request = new XMLHttpRequest();
        var params = "readerId=" + readerElement.value;
        request.open("GET", "reader?" + params, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            var reader = JSON.parse(this.responseText);
            readerElement.value = reader.readerId;
            loginInput.value = reader.login;
            passwordInput.value = reader.password;

        };
        request.send();
    }

    function getAll() {
        var requestToSubs = new XMLHttpRequest();
        requestToSubs.open("GET", "reader", true);
        requestToSubs.setRequestHeader("Content-Type",
            "application/x-www-form-urlencoded");
        requestToSubs.onreadystatechange = function (ev) {
            if(this.readyState != XMLHttpRequest.DONE)
                return;
            var readers = JSON.parse(this.responseText);
            while(table.firstChild){
                table.removeChild(table.firstChild);
            }
            languageElement.value = readers[0]["languageId"];
            for(var i = 0; i < readers.length; i++){
                var tr = document.createElement("tr");
                var tdId = document.createElement("td");
                var textId = document.createTextNode(readers[i]["readerId"]);
                var tdLogin = document.createElement("td");
                var textLogin = document.createTextNode(readers[i]["login"]);
                var tdPassword = document.createElement("td");
                var textPassword = document.createTextNode(readers[i]["password"]);
                tdId.appendChild(textId);
                tdLogin.appendChild(textLogin);
                tdPassword.appendChild(textPassword);
                tr.appendChild(tdId);
                tr.appendChild(tdLogin);
                tr.appendChild(tdPassword);
                table.appendChild(tr);
            }
        };
        requestToSubs.send();
    }

</script>
</html>